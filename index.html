<!DOCTYPE html>
<html>
  <head>
    <title>Test Chat</title>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"> </script>
    <link href='http://fonts.googleapis.com/css?family=Hind:500' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href='index.css'/>
  </head>
  <body>
    <div id="message-container">
      <ul id="messages"></ul>
    </div>
    <form id="typebar" action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <script>
      var socket = io();
      $('form').submit(function(){
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });
      function getName(val){
        var name = val + "=";
        var ca = document.cookie.split(';');
        for(var i = 0; i<ca.length; i++){
          var c = ca[i];
          while(c.charAt(0)==' '){
            c = c.substring(1);
          }
          if(c.indexOf(name)==0){
            return c.substring(name.length,c.length);
          }
        }
        return "";
      }
      socket.on('pageload', function(data){
        if(getName('name')==""){
          var userName = prompt("Please enter your name:");
          document.cookie="name="+userName;
        }
        else{
          var userName = getName('name');
        }
        socket.emit("username", userName);
        //socket.emit("add", "<i>" + userName + " joined.</i>");
        for(var i = 0; i<data.length; i++){
          $('#messages').append("<li>" + data[i] + "</li>");
        }
        socket.emit("add", "<i>" + userName + " joined.</i>");
        var messagesize= $(window).height() - 45;
        $('#message-container').css('height', '' + messagesize + 'px');
        $('#message-container').scrollTop(10000);
        messagesize = messagesize + 2;
        $('#typebar').css('top','' + messagesize + 'px');
      });
      socket.on('disconnect', function(){
        //$('#messages').append("<li><i>" + getName('name') + " left</i></li>");
        socket.emit("add", "<i>" + getName('name') + " left</i>");
      });
      socket.on('chat message', function(obj){
        $('#messages').append("<li>" + obj.id + ": " + obj.message + "</li>");
        $('#message-container').scrollTop(10000);
      });
      socket.on('info message', function(message){
        $('#messages').append("<li>" + message + "</li>");
        $('#message-container').scrollTop(10000);
      });
      socket.on('cutmessages', function(data){
        $('#messages').empty();
        for(var i = 0; i<data.length; i++){
          $('#messages').append("<li>" + data[i] + "</li>");
        }
      });
      socket.on('hannah', function(obj) {
          $('#messages').append("<li>" + obj.id + ": " + "<br><img src='http://33.media.tumblr.com/26bf203475c4f4350c6d837da9e25a3f/tumblr_mucnehOqeX1rby04wo1_1280.gif' /></li><br><br>");
      });
      socket.on('greg', function(obj) {
          $('#messages').append("<li>" + obj.id + ": " + "<br><img src='http://media.giphy.com/media/GFLcKd6MXid2M/giphy.gif' /></li><br><br>");
      });
      socket.on('reenu', function(obj) {
          $('#messages').append("<li>" + obj.id + ": " + "<br><img src='http://media.giphy.com/media/PFXmxJoyTNfDG/giphy.gif' /></li><br><br>");
      });
      socket.on('shrug', function(obj) {
        $('#messages').append("<li>" + obj.id + ": " + "<br><img src='http://media.giphy.com/media/y65VoOlimZaus/giphy.gif' /></li><br><br>");
      });
      socket.on('giphy', function(obj) {
          $('#messages').append("<li>" + obj.id + ": " + "<b>" + obj.message + "</b><br>" +  "<img src='" + obj.gurl + "' /></li>");
      });
      socket.on('numusers', function(obj) {
        $('#messages').append("<li>OP: " + obj.count);
      });
      socket.on('erase chat', function(message){
        $('#messages').empty();
      });
      socket.on('changename', function(obj){
        //$('#messages').append("<li><i>"+getName("name") + " changed name to " + name + "</i></li>");
        if(getName("name")===obj.oldName){
          socket.emit("add", "<i>"+obj.oldName + " changed name to " + obj.newName + "</i>");
          window.alert("in if");
          document.cookie="name="+obj.newName;
          socket.emit("username", obj.newName);
        }
      });
      socket.on('left', function(user){
        socket.emit("add", "<i>" + user + " left.</i>");
      });
    </script>
  </body>
</html>
